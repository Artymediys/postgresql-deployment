# Ansible роли для развёртывания PostgreSQL
Репозиторий состоит из двух ролей:
- `postgres_main` – установка и конфигурирование **PostgreSQL** в режиме **Single Node**
- `postgres_extra` – создание дополнительных пользователей, баз данных, схем с указанными правами

## Зависимости
Роли писались и тестировались под **Oracle Linux 8** и **9**.

В задачах ролей **не** используется **ansible**-модуль для работы с **postgres**,
поэтому установка дополнительных пакетов не требуется.

## Конфигурация
Для каждой роли предусмотрен набор переменных, располагающийся в файле `roles/<role_name>/defaults/main.yml`.

### Переменные роли `postgres_main`:
- `postgres_version` – **Версия PostgreSQL**. Указывает версию PostgreSQL, которую необходимо установить и настроить (например, `'17'`).

- `postgres_gpg_key` – **URL GPG-ключа PostgreSQL**. Ссылка на GPG-ключ, используемый для проверки подлинности пакетов PostgreSQL из репозитория.

- `postgres_repo_link` – **Ссылка на репозиторий PostgreSQL**. URL-адрес RPM-пакета репозитория PostgreSQL, необходимого для установки PostgreSQL через менеджер пакетов (например, `yum` или `dnf`).

- `postgres_user` – **Системный пользователь PostgreSQL**. Имя пользователя системы, под которым будет запускаться служба PostgreSQL (по умолчанию `'postgres'`).

- `postgres_group` – **Системная группа PostgreSQL**. Имя группы системы, под которой будет запускаться служба PostgreSQL (по умолчанию `'postgres'`).

- `postgres_service_name` – **Имя службы PostgreSQL**. Имя службы PostgreSQL в системе, обычно включает версию (например, `'postgresql-17'`).

- `postgres_data_dir` – **Каталог данных PostgreSQL**. Путь к директории, где будут храниться данные PostgreSQL (например, `'/var/lib/pgsql/17/data'`).

- `postgres_conf_dir` – **Каталог конфигурации PostgreSQL**. Путь к директории, содержащей конфигурационные файлы PostgreSQL (например, `'/var/lib/pgsql/17/data'`).

- `postgres_log_directory` – **Каталог логов PostgreSQL**. Путь к директории, где будут сохраняться лог-файлы PostgreSQL (например, `'/var/log/postgresql'`).

- `postgres_superuser_password` – **Пароль суперпользователя PostgreSQL**. Пароль для суперпользователя PostgreSQL (пользователя `'postgres'`).

- `postgres_port` – **Порт PostgreSQL**. Номер порта, на котором PostgreSQL будет слушать входящие соединения (по умолчанию `5432`).

- `postgres_listen_addresses` – **Адреса для прослушивания PostgreSQL**. Сетевые адреса, на которых PostgreSQL будет принимать подключения (например, `'0.0.0.0'` для всех интерфейсов).

- `postgres_allowed_networks` – **Разрешённые сети для подключения**. Список сетевых конфигураций, указывающих, какие IP-адреса или диапазоны разрешены для подключения и какой метод аутентификации использовать.
    - **Пример:**
      ```yaml
      postgres_allowed_networks:
        - { address: '192.168.1.0/24', method: 'scram-sha-256' }
      ```

- **`postgres_max_connections`** – **Максимальное количество подключений**. Устанавливает максимальное количество одновременных подключений к PostgreSQL (например, `'100'`).

- **`postgres_auth_method`** – **Метод аутентификации PostgreSQL**. Определяет метод аутентификации, используемый PostgreSQL (например, `'scram-sha-256'`).

- **`postgres_logging_collector`** – **Включение логирования**. Определяет, будет ли включён сборщик логов PostgreSQL (например, `'on'`).

- **`postgres_log_rotation_age`** – **Возраст лог-файла до ротации**. Указывает время, после которого лог-файлы PostgreSQL будут ротироваться (например, `'1d'` для одного дня).

- **`postgres_log_rotation_size`** – **Размер лог-файла до ротации**. Указывает максимальный размер лог-файла PostgreSQL, после которого он будет принудительно ротироваться (например, `'1GB'`).

- **`postgres_extra_config_parameters`** – **Дополнительные параметры конфигурации PostgreSQL**. Словарь, содержащий дополнительные параметры для настройки производительности и поведения PostgreSQL. Включает следующие подпеременные:
    - **`checkpoint_timeout`** – **Таймаут чекпойнта (перенос данных из WAL на диск)**. Устанавливает время между автоматическими чекпойнтами WAL (например, `'30min'`).
    - **`checkpoint_completion_target`** – **Целевая завершённость чекпойнта**. Указывает целевое время завершения чекпойнта как долю от интервала чекпойнта (например, `'0.6'`).
    - **`max_wal_size`** – **Максимальный размер WAL**. Устанавливает максимальный размер WAL-файлов перед автоматическим чекпойнтом (например, `'15GB'`).
    - **`min_wal_size`** – **Минимальный размер WAL**. Устанавливает минимальный размер WAL-файлов перед автоматическим чекпойнтом (например, `'2GB'`).
    - **`work_mem`** – **Память для операций работы**. Определяет объём памяти, выделяемый для внутренних сортировок и хеш-таблиц до записи на диск (например, `'128MB'`).
    - **`maintenance_work_mem`** – **Память для операций обслуживания**. Определяет объём памяти, выделяемый для операций обслуживания, таких как `VACUUM` и `CREATE INDEX` (например, `'128MB'`).
    - **`autovacuum_work_mem`** – **Память для автовакуума**. Определяет объём памяти, выделяемый для процессов автовакуума (например, `'528MB'`).
    - **`autovacuum_vacuum_scale_factor`** – **Коэффициент масштабирования для `VACUUM`**. Устанавливает долю размера таблицы, при превышении которой запускается автовакуум `VACUUM` (например, `'0.1'`).
    - **`autovacuum_analyze_scale_factor`** – **Коэффициент масштабирования для `ANALYZE`**. Устанавливает долю размера таблицы, при превышении которой запускается автовакуум `ANALYZE` (например, `'0.1'`).
    - **`autovacuum_max_workers`** – **Максимальное количество работников автовакуума**. Устанавливает максимальное количество одновременных процессов автовакуума (например, `'5'`).
    - **`vacuum_cost_limit`** – **Лимит стоимости вакуума**. Устанавливает лимит стоимости операций вакуума для контроля ввода-вывода (например, `'2000'`).
    - **`shared_buffers`** – **Общие буферы**. Определяет объём памяти, выделяемый для общих буферов PostgreSQL (например, `'4GB'`).
    - **`effective_cache_size`** – **Эффективный размер кэша**. Оценивает, сколько памяти доступно для кэширования дисковых данных операционной системой и самим базой данных (например, `'2GB'`).
    - **`max_locks_per_transaction`** – **Максимальное количество блокировок на транзакцию**. Устанавливает максимальное количество блокировок, которые могут быть установлены в одной транзакции (например, `'64'`).
    - **`max_worker_processes`** – **Максимальное количество рабочих процессов**. Определяет максимальное количество фоновых рабочих процессов PostgreSQL (например, `'8'`).


### Переменные роли `postgres_extra`:
- **`postgres_extra_users`** – **Дополнительные пользователи PostgreSQL**. Список дополнительных пользователей, которые будут созданы в PostgreSQL. Каждый пользователь определяется следующими подпеременными:
    - **`name`** – **Имя пользователя**. Имя нового пользователя PostgreSQL (например, `'test_user'`).
    - **`password`** – **Пароль пользователя**. Пароль для нового пользователя PostgreSQL (например, `'test1234#'`).
    - **`privileges`** – **Привилегии пользователя**. Список привилегий, предоставляемых пользователю (например, `'CREATEDB'`, `'CREATEROLE'`, `'LOGIN'`). Возможные значения включают:
        - `'CREATEDB'` – Разрешает пользователю создавать базы данных.
        - `'CREATEROLE'` – Разрешает пользователю создавать и управлять ролями.
        - `'LOGIN'` – Разрешает пользователю аутентифицироваться и подключаться к базе данных.
        - Другие привилегии: `'SUPERUSER'`, `'REPLICATION'`, и т.д.

- **`postgres_extra_databases`** – **Дополнительные базы данных PostgreSQL**. Список дополнительных баз данных, которые будут созданы в PostgreSQL. Каждая база данных определяется следующими подпеременными:
    - **`name`** – **Имя базы данных**. Имя новой базы данных PostgreSQL (например, `'test_db'`).
    - **`owner`** – **Владелец базы данных**. Имя пользователя PostgreSQL, которому будет принадлежать новая база данных (например, `'test_user'`).

- **`postgres_extra_schemas`** – **Дополнительные схемы PostgreSQL**. Список дополнительных схем, которые будут созданы в указанных базах данных. Каждая схема определяется следующими подпеременными:
    - **`name`** – **Имя схемы**. Имя новой схемы PostgreSQL (например, `'test_schema'`).
    - **`database`** – **База данных**. Имя базы данных, в которой будет создана схема (например, `'test_db'`).
    - **`owner`** – **Владелец схемы**. Имя пользователя PostgreSQL, которому будет принадлежать новая схема (например, `'test_user'`).

- **`postgres_extra_schema_privileges`** – **Привилегии на схемы для пользователей**. Список привилегий, которые будут предоставлены пользователям на определённые схемы. Каждая запись определяется следующими подпеременными:
    - **`name`** – **Имя схемы**. Имя схемы, на которую предоставляются привилегии (например, `'test_schema'`).
    - **`database`** – **База данных**. Имя базы данных, содержащей схему (например, `'test_db'`).
    - **`grantee`** – **Получатель привилегий**. Имя пользователя PostgreSQL, которому предоставляются привилегии (например, `'extra_user'`).
    - **`privileges`** – **Список привилегий**. Список привилегий, предоставляемых пользователю на схему (например, `'USAGE'`, `'CREATE'`). Возможные значения включают:
        - `'USAGE'` – Позволяет пользователю использовать объекты в схеме (например, выполнять запросы).
        - `'CREATE'` – Позволяет пользователю создавать новые объекты в схеме (например, таблицы, представления).
        - `'ALL PRIVILEGES'` – Предоставляет все доступные привилегии на схему.
        - Другие привилегии: `'SELECT'`, `'INSERT'`, `'UPDATE'`, `'DELETE'`

## Пример использования

Роль `postgres_main`:
```yaml
- name: Installing and configuring PostgreSQL
  hosts: psql_server
  become: true
  roles:
    - postgres_main
```

Роль `postgres_extra`:
```yaml
- name: Adding and configuring extra PostgreSQL objects
  hosts: psql_server
  become: true
  roles:
    - postgres_extra
```